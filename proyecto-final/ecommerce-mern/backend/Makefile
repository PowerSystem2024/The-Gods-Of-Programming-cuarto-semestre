# ============================================
# ğŸ”§ MAKEFILE - BACKEND (Node.js + Express)
# ============================================

.PHONY: help install dev start build test clean seed db-shell lint format docker-build docker-run

# Colores para output
GREEN  := \033[0;32m
YELLOW := \033[0;33m
BLUE   := \033[0;34m
RED    := \033[0;31m
NC     := \033[0m # No Color

# Variables
NODE_VERSION := 20
NPM := npm
PORT := 5000

# ============================================
# ğŸ“š AYUDA
# ============================================

help: ## Mostrar esta ayuda
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)  ğŸ”§ BACKEND - Comandos Disponibles$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

# ============================================
# ğŸ“¦ INSTALACIÃ“N
# ============================================

install: ## Instalar dependencias
	@echo "$(GREEN)ğŸ“¦ Instalando dependencias...$(NC)"
	$(NPM) install
	@echo "$(GREEN)âœ… Dependencias instaladas$(NC)"

install-prod: ## Instalar solo dependencias de producciÃ³n
	@echo "$(GREEN)ğŸ“¦ Instalando dependencias de producciÃ³n...$(NC)"
	$(NPM) install --production
	@echo "$(GREEN)âœ… Dependencias de producciÃ³n instaladas$(NC)"

update: ## Actualizar dependencias
	@echo "$(YELLOW)ğŸ”„ Actualizando dependencias...$(NC)"
	$(NPM) update
	@echo "$(GREEN)âœ… Dependencias actualizadas$(NC)"

# ============================================
# ğŸš€ DESARROLLO
# ============================================

dev: ## Ejecutar en modo desarrollo con nodemon
	@echo "$(GREEN)ğŸš€ Iniciando servidor en modo desarrollo...$(NC)"
	@echo "$(BLUE)ğŸŒ http://localhost:$(PORT)$(NC)"
	$(NPM) run dev

start: ## Ejecutar en modo producciÃ³n
	@echo "$(GREEN)ğŸš€ Iniciando servidor en modo producciÃ³n...$(NC)"
	@echo "$(BLUE)ğŸŒ http://localhost:$(PORT)$(NC)"
	NODE_ENV=production node server.js

watch: ## Ejecutar con auto-reload (alias de dev)
	@$(MAKE) dev

# ============================================
# ğŸ—„ï¸ BASE DE DATOS
# ============================================

seed: ## Poblar base de datos con datos de ejemplo
	@echo "$(GREEN)ğŸŒ± Poblando base de datos...$(NC)"
	node scripts/seed.js
	@echo "$(GREEN)âœ… Base de datos poblada$(NC)"

seed-products: ## Poblar solo productos
	@echo "$(GREEN)ğŸ›ï¸ Poblando productos...$(NC)"
	node seed-products.js
	@echo "$(GREEN)âœ… Productos poblados$(NC)"

db-shell: ## Abrir MongoDB shell
	@echo "$(BLUE)ğŸ—„ï¸ Abriendo MongoDB shell...$(NC)"
	@if [ -z "$$MONGODB_URI" ]; then \
		echo "$(RED)âŒ MONGODB_URI no estÃ¡ definida$(NC)"; \
		exit 1; \
	fi
	mongosh "$$MONGODB_URI"

db-backup: ## Crear backup de la base de datos
	@echo "$(GREEN)ğŸ’¾ Creando backup...$(NC)"
	@mkdir -p backups
	mongodump --uri="$$MONGODB_URI" --out=backups/backup-$$(date +%Y%m%d-%H%M%S)
	@echo "$(GREEN)âœ… Backup creado$(NC)"

# ============================================
# ğŸ§ª TESTING
# ============================================

test: ## Ejecutar tests
	@echo "$(GREEN)ğŸ§ª Ejecutando tests...$(NC)"
	$(NPM) test

test-watch: ## Ejecutar tests en modo watch
	@echo "$(GREEN)ğŸ§ª Ejecutando tests en modo watch...$(NC)"
	$(NPM) test -- --watch

test-coverage: ## Ejecutar tests con coverage
	@echo "$(GREEN)ğŸ§ª Ejecutando tests con cobertura...$(NC)"
	$(NPM) test -- --coverage

# ============================================
# ğŸ” CALIDAD DE CÃ“DIGO
# ============================================

lint: ## Ejecutar linter
	@echo "$(GREEN)ğŸ” Ejecutando linter...$(NC)"
	$(NPM) run lint || echo "$(YELLOW)âš ï¸ Lint no configurado$(NC)"

lint-fix: ## Corregir problemas de linting automÃ¡ticamente
	@echo "$(GREEN)ğŸ”§ Corrigiendo problemas de linting...$(NC)"
	$(NPM) run lint:fix || echo "$(YELLOW)âš ï¸ Lint no configurado$(NC)"

format: ## Formatear cÃ³digo con Prettier
	@echo "$(GREEN)âœ¨ Formateando cÃ³digo...$(NC)"
	$(NPM) run format || npx prettier --write "**/*.{js,json,md}"

# ============================================
# ğŸ³ DOCKER
# ============================================

docker-build: ## Construir imagen Docker
	@echo "$(GREEN)ğŸ³ Construyendo imagen Docker...$(NC)"
	docker build -t ecommerce-backend:latest .
	@echo "$(GREEN)âœ… Imagen construida$(NC)"

docker-run: ## Ejecutar contenedor Docker
	@echo "$(GREEN)ğŸ³ Ejecutando contenedor...$(NC)"
	docker run -p $(PORT):$(PORT) --env-file .env ecommerce-backend:latest

docker-shell: ## Abrir shell en contenedor
	@echo "$(BLUE)ğŸ³ Abriendo shell en contenedor...$(NC)"
	docker run -it --rm ecommerce-backend:latest sh

# ============================================
# ğŸ§¹ LIMPIEZA
# ============================================

clean: ## Limpiar archivos generados
	@echo "$(YELLOW)ğŸ§¹ Limpiando archivos...$(NC)"
	rm -rf node_modules
	rm -rf logs/*
	rm -rf uploads/*
	rm -f *.log
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

clean-cache: ## Limpiar cachÃ© de npm
	@echo "$(YELLOW)ğŸ§¹ Limpiando cachÃ©...$(NC)"
	$(NPM) cache clean --force
	@echo "$(GREEN)âœ… CachÃ© limpiada$(NC)"

clean-all: clean clean-cache ## Limpieza completa

# ============================================
# ğŸ“Š INFORMACIÃ“N
# ============================================

info: ## Mostrar informaciÃ³n del proyecto
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(GREEN)  ğŸ“Š BACKEND - InformaciÃ³n$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(YELLOW)Node:$(NC)        $$(node --version 2>/dev/null || echo 'No instalado')"
	@echo "$(YELLOW)NPM:$(NC)         $$(npm --version 2>/dev/null || echo 'No instalado')"
	@echo "$(YELLOW)Puerto:$(NC)      $(PORT)"
	@echo "$(YELLOW)Dependencias:$(NC) $$(ls node_modules 2>/dev/null | wc -l) paquetes"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

deps: ## Listar dependencias instaladas
	@echo "$(GREEN)ğŸ“¦ Dependencias instaladas:$(NC)"
	@$(NPM) list --depth=0

outdated: ## Verificar dependencias desactualizadas
	@echo "$(YELLOW)ğŸ” Verificando dependencias desactualizadas...$(NC)"
	@$(NPM) outdated

audit: ## AuditorÃ­a de seguridad
	@echo "$(GREEN)ğŸ”’ Ejecutando auditorÃ­a de seguridad...$(NC)"
	@$(NPM) audit

audit-fix: ## Corregir vulnerabilidades automÃ¡ticamente
	@echo "$(GREEN)ğŸ”§ Corrigiendo vulnerabilidades...$(NC)"
	@$(NPM) audit fix

# ============================================
# ğŸ”§ UTILIDADES
# ============================================

logs: ## Ver logs del servidor
	@echo "$(BLUE)ğŸ“‹ Mostrando logs...$(NC)"
	@tail -f logs/*.log 2>/dev/null || echo "$(YELLOW)No hay logs disponibles$(NC)"

check-env: ## Verificar variables de entorno
	@echo "$(GREEN)ğŸ” Verificando variables de entorno...$(NC)"
	@node -e "require('dotenv').config(); \
		const required = ['MONGODB_URI', 'JWT_SECRET', 'SESSION_SECRET']; \
		required.forEach(v => console.log(v + ':', process.env[v] ? 'âœ…' : 'âŒ'));"

create-env: ## Crear archivo .env de ejemplo
	@echo "$(GREEN)ğŸ“ Creando .env de ejemplo...$(NC)"
	@if [ ! -f .env ]; then \
		echo "PORT=5000" > .env; \
		echo "MONGODB_URI=mongodb://localhost:27017/ecommerce" >> .env; \
		echo "JWT_SECRET=tu-secreto-jwt-aqui" >> .env; \
		echo "SESSION_SECRET=tu-secreto-session-aqui" >> .env; \
		echo "FRONTEND_URL=http://localhost:3000" >> .env; \
		echo "$(GREEN)âœ… Archivo .env creado$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸ El archivo .env ya existe$(NC)"; \
	fi

# ============================================
# ğŸ¯ ATAJOS
# ============================================

i: install ## Atajo para install
d: dev ## Atajo para dev
s: start ## Atajo para start
t: test ## Atajo para test
c: clean ## Atajo para clean
