# Makefile para E-commerce MERN
.PHONY: help build up down restart logs clean test dev install seed

# Variables
DOCKER_COMPOSE = docker-compose
BACKEND_DIR = backend
FRONTEND_DIR = frontend

# Colores para output
GREEN = \033[0;32m
YELLOW = \033[0;33m
RED = \033[0;31m
NC = \033[0m # No Color

##@ Ayuda

help: ## Mostrar esta ayuda
	@echo "$(GREEN)E-commerce MERN - Comandos disponibles:$(NC)"
	@awk 'BEGIN {FS = ":.*##"; printf "\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  $(YELLOW)%-15s$(NC) %s\n", $$1, $$2 } /^##@/ { printf "\n$(GREEN)%s$(NC)\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ Docker - ProducciÃ³n

build: ## Construir todas las imÃ¡genes Docker
	@echo "$(GREEN)ðŸ“¦ Construyendo imÃ¡genes Docker...$(NC)"
	$(DOCKER_COMPOSE) build

up: ## Levantar todos los servicios (detached)
	@echo "$(GREEN)ðŸš€ Levantando servicios...$(NC)"
	$(DOCKER_COMPOSE) up -d
	@echo "$(GREEN)âœ… Servicios iniciados:$(NC)"
	@echo "  - Frontend: http://localhost:3000"
	@echo "  - Backend:  http://localhost:5000"
	@echo "  - MongoDB:  mongodb://localhost:27017"

down: ## Detener y eliminar todos los servicios
	@echo "$(RED)ðŸ›‘ Deteniendo servicios...$(NC)"
	$(DOCKER_COMPOSE) down

restart: ## Reiniciar todos los servicios
	@echo "$(YELLOW)ðŸ”„ Reiniciando servicios...$(NC)"
	$(DOCKER_COMPOSE) restart

logs: ## Ver logs de todos los servicios
	$(DOCKER_COMPOSE) logs -f

logs-backend: ## Ver logs del backend
	$(DOCKER_COMPOSE) logs -f backend

logs-frontend: ## Ver logs del frontend
	$(DOCKER_COMPOSE) logs -f frontend

logs-db: ## Ver logs de MongoDB
	$(DOCKER_COMPOSE) logs -f mongodb

status: ## Ver estado de los servicios
	@echo "$(GREEN)ðŸ“Š Estado de servicios:$(NC)"
	$(DOCKER_COMPOSE) ps

##@ Docker - Desarrollo

dev: ## Levantar servicios en modo desarrollo (con logs)
	@echo "$(GREEN)ðŸ”§ Iniciando en modo desarrollo...$(NC)"
	$(DOCKER_COMPOSE) up

rebuild: ## Reconstruir y levantar servicios
	@echo "$(YELLOW)ðŸ”¨ Reconstruyendo servicios...$(NC)"
	$(DOCKER_COMPOSE) up -d --build

clean: ## Limpiar contenedores, volÃºmenes e imÃ¡genes
	@echo "$(RED)ðŸ§¹ Limpiando Docker...$(NC)"
	$(DOCKER_COMPOSE) down -v --remove-orphans
	@echo "$(YELLOW)âš ï¸  Eliminando imÃ¡genes huÃ©rfanas...$(NC)"
	docker image prune -f

clean-all: ## Limpieza completa (incluye imÃ¡genes del proyecto)
	@echo "$(RED)ðŸ—‘ï¸  Limpieza completa...$(NC)"
	$(DOCKER_COMPOSE) down -v --rmi all --remove-orphans
	docker image prune -af

##@ InstalaciÃ³n Local

install: ## Instalar dependencias (backend + frontend)
	@echo "$(GREEN)ðŸ“¥ Instalando dependencias...$(NC)"
	@echo "$(YELLOW)Backend...$(NC)"
	cd $(BACKEND_DIR) && npm install
	@echo "$(YELLOW)Frontend...$(NC)"
	cd $(FRONTEND_DIR) && npm install
	@echo "$(GREEN)âœ… InstalaciÃ³n completa$(NC)"

install-backend: ## Instalar solo dependencias del backend
	@echo "$(GREEN)ðŸ“¥ Instalando dependencias del backend...$(NC)"
	cd $(BACKEND_DIR) && npm install

install-frontend: ## Instalar solo dependencias del frontend
	@echo "$(GREEN)ðŸ“¥ Instalando dependencias del frontend...$(NC)"
	cd $(FRONTEND_DIR) && npm install

##@ Desarrollo Local

dev-backend: ## Ejecutar backend en modo desarrollo (local)
	@echo "$(GREEN)ðŸš€ Iniciando backend (desarrollo)...$(NC)"
	cd $(BACKEND_DIR) && npm run dev

dev-frontend: ## Ejecutar frontend en modo desarrollo (local)
	@echo "$(GREEN)ðŸš€ Iniciando frontend (desarrollo)...$(NC)"
	cd $(FRONTEND_DIR) && npm run dev

build-frontend: ## Hacer build del frontend
	@echo "$(GREEN)ðŸ“¦ Construyendo frontend...$(NC)"
	cd $(FRONTEND_DIR) && npm run build

##@ Base de Datos

seed: ## Poblar base de datos con datos de ejemplo
	@echo "$(GREEN)ðŸŒ± Poblando base de datos...$(NC)"
	cd $(BACKEND_DIR) && npm run seed

db-shell: ## Abrir shell de MongoDB en el contenedor
	@echo "$(GREEN)ðŸš Abriendo MongoDB shell...$(NC)"
	$(DOCKER_COMPOSE) exec mongodb mongosh -u admin -p admin123 --authenticationDatabase admin ecommerce

##@ Testing

test: ## Ejecutar tests (cuando estÃ©n disponibles)
	@echo "$(YELLOW)âš ï¸  Tests no implementados aÃºn$(NC)"

##@ InformaciÃ³n

info: ## Mostrar informaciÃ³n del proyecto
	@echo "$(GREEN)â„¹ï¸  InformaciÃ³n del Proyecto$(NC)"
	@echo ""
	@echo "$(YELLOW)URLs de Desarrollo:$(NC)"
	@echo "  Frontend: http://localhost:3000"
	@echo "  Backend:  http://localhost:5000/api"
	@echo "  Health:   http://localhost:5000/api/health"
	@echo ""
	@echo "$(YELLOW)MongoDB:$(NC)"
	@echo "  Host:     localhost:27017"
	@echo "  Database: ecommerce"
	@echo "  User:     admin"
	@echo "  Pass:     admin123"
	@echo ""
	@echo "$(YELLOW)Comandos Ãºtiles:$(NC)"
	@echo "  make help        - Ver todos los comandos"
	@echo "  make up          - Levantar servicios"
	@echo "  make logs        - Ver logs"
	@echo "  make down        - Detener servicios"

version: ## Mostrar versiones de las herramientas
	@echo "$(GREEN)ðŸ”§ Versiones:$(NC)"
	@echo "Docker:         $$(docker --version)"
	@echo "Docker Compose: $$(docker-compose --version)"
	@echo "Node.js:        $$(node --version 2>/dev/null || echo 'No instalado')"
	@echo "npm:            $$(npm --version 2>/dev/null || echo 'No instalado')"
