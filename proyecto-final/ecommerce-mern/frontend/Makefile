# ============================================
# ‚öõÔ∏è MAKEFILE - FRONTEND (React + Vite)
# ============================================

.PHONY: help install dev build preview test clean lint format docker-build docker-run

# Colores para output
GREEN  := \033[0;32m
YELLOW := \033[0;33m
BLUE   := \033[0;34m
RED    := \033[0;31m
NC     := \033[0m # No Color

# Variables
NODE_VERSION := 20
NPM := npm
DEV_PORT := 3000
PREVIEW_PORT := 4173
DIST_DIR := dist

# ============================================
# üìö AYUDA
# ============================================

help: ## Mostrar esta ayuda
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(GREEN)  ‚öõÔ∏è FRONTEND - Comandos Disponibles$(NC)"
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

# ============================================
# üì¶ INSTALACI√ìN
# ============================================

install: ## Instalar dependencias
	@echo "$(GREEN)üì¶ Instalando dependencias...$(NC)"
	$(NPM) install
	@echo "$(GREEN)‚úÖ Dependencias instaladas$(NC)"

install-prod: ## Instalar solo dependencias de producci√≥n
	@echo "$(GREEN)üì¶ Instalando dependencias de producci√≥n...$(NC)"
	$(NPM) install --production
	@echo "$(GREEN)‚úÖ Dependencias de producci√≥n instaladas$(NC)"

update: ## Actualizar dependencias
	@echo "$(YELLOW)üîÑ Actualizando dependencias...$(NC)"
	$(NPM) update
	@echo "$(GREEN)‚úÖ Dependencias actualizadas$(NC)"

# ============================================
# üöÄ DESARROLLO
# ============================================

dev: ## Ejecutar servidor de desarrollo (Vite)
	@echo "$(GREEN)üöÄ Iniciando servidor de desarrollo...$(NC)"
	@echo "$(BLUE)üåê http://localhost:$(DEV_PORT)$(NC)"
	$(NPM) run dev

start: dev ## Alias para dev

watch: dev ## Alias para dev

# ============================================
# üèóÔ∏è BUILD
# ============================================

build: ## Construir para producci√≥n
	@echo "$(GREEN)üèóÔ∏è Construyendo aplicaci√≥n...$(NC)"
	$(NPM) run build
	@echo "$(GREEN)‚úÖ Build completado en $(DIST_DIR)/$(NC)"

build-clean: clean build ## Limpiar y construir

preview: build ## Previsualizar build de producci√≥n
	@echo "$(GREEN)üëÄ Previsualizando build...$(NC)"
	@echo "$(BLUE)üåê http://localhost:$(PREVIEW_PORT)$(NC)"
	$(NPM) run preview

analyze: build ## Analizar tama√±o del bundle
	@echo "$(GREEN)üìä Analizando bundle...$(NC)"
	@npx vite-bundle-visualizer

# ============================================
# üß™ TESTING
# ============================================

test: ## Ejecutar tests
	@echo "$(GREEN)üß™ Ejecutando tests...$(NC)"
	$(NPM) test || echo "$(YELLOW)‚ö†Ô∏è Tests no configurados$(NC)"

test-watch: ## Ejecutar tests en modo watch
	@echo "$(GREEN)üß™ Ejecutando tests en modo watch...$(NC)"
	$(NPM) test -- --watch || echo "$(YELLOW)‚ö†Ô∏è Tests no configurados$(NC)"

test-coverage: ## Ejecutar tests con coverage
	@echo "$(GREEN)üß™ Ejecutando tests con cobertura...$(NC)"
	$(NPM) test -- --coverage || echo "$(YELLOW)‚ö†Ô∏è Tests no configurados$(NC)"

test-ui: ## Ejecutar tests con interfaz visual
	@echo "$(GREEN)üß™ Ejecutando tests UI...$(NC)"
	$(NPM) test -- --ui || echo "$(YELLOW)‚ö†Ô∏è Tests no configurados$(NC)"

# ============================================
# üîç CALIDAD DE C√ìDIGO
# ============================================

lint: ## Ejecutar linter (ESLint)
	@echo "$(GREEN)üîç Ejecutando linter...$(NC)"
	$(NPM) run lint

lint-fix: ## Corregir problemas de linting autom√°ticamente
	@echo "$(GREEN)üîß Corrigiendo problemas de linting...$(NC)"
	$(NPM) run lint -- --fix

format: ## Formatear c√≥digo con Prettier
	@echo "$(GREEN)‚ú® Formateando c√≥digo...$(NC)"
	$(NPM) run format || npx prettier --write "src/**/*.{js,jsx,ts,tsx,css,json}"

format-check: ## Verificar formato sin modificar
	@echo "$(GREEN)üîç Verificando formato...$(NC)"
	npx prettier --check "src/**/*.{js,jsx,ts,tsx,css,json}"

type-check: ## Verificar tipos (si usas TypeScript)
	@echo "$(GREEN)üìù Verificando tipos...$(NC)"
	@if [ -f "tsconfig.json" ]; then \
		npx tsc --noEmit; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è No se encontr√≥ tsconfig.json$(NC)"; \
	fi

# ============================================
# üê≥ DOCKER
# ============================================

docker-build: ## Construir imagen Docker
	@echo "$(GREEN)üê≥ Construyendo imagen Docker...$(NC)"
	docker build -t ecommerce-frontend:latest .
	@echo "$(GREEN)‚úÖ Imagen construida$(NC)"

docker-run: ## Ejecutar contenedor Docker
	@echo "$(GREEN)üê≥ Ejecutando contenedor...$(NC)"
	docker run -p 3000:80 ecommerce-frontend:latest

docker-shell: ## Abrir shell en contenedor
	@echo "$(BLUE)üê≥ Abriendo shell en contenedor...$(NC)"
	docker run -it --rm ecommerce-frontend:latest sh

# ============================================
# üßπ LIMPIEZA
# ============================================

clean: ## Limpiar archivos generados
	@echo "$(YELLOW)üßπ Limpiando archivos...$(NC)"
	rm -rf $(DIST_DIR)
	rm -rf node_modules
	rm -rf .vite
	rm -f *.log
	@echo "$(GREEN)‚úÖ Limpieza completada$(NC)"

clean-cache: ## Limpiar cach√© de npm y Vite
	@echo "$(YELLOW)üßπ Limpiando cach√©...$(NC)"
	$(NPM) cache clean --force
	rm -rf node_modules/.vite
	@echo "$(GREEN)‚úÖ Cach√© limpiada$(NC)"

clean-all: clean clean-cache ## Limpieza completa

# ============================================
# üìä INFORMACI√ìN
# ============================================

info: ## Mostrar informaci√≥n del proyecto
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(GREEN)  üìä FRONTEND - Informaci√≥n$(NC)"
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(YELLOW)Node:$(NC)        $$(node --version 2>/dev/null || echo 'No instalado')"
	@echo "$(YELLOW)NPM:$(NC)         $$(npm --version 2>/dev/null || echo 'No instalado')"
	@echo "$(YELLOW)Vite:$(NC)        $$(npx vite --version 2>/dev/null | head -n1 || echo 'No instalado')"
	@echo "$(YELLOW)Puerto Dev:$(NC)  $(DEV_PORT)"
	@echo "$(YELLOW)Puerto Prev:$(NC) $(PREVIEW_PORT)"
	@echo "$(YELLOW)Build Dir:$(NC)   $(DIST_DIR)"
	@echo "$(YELLOW)Dependencias:$(NC) $$(ls node_modules 2>/dev/null | wc -l) paquetes"
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"

deps: ## Listar dependencias instaladas
	@echo "$(GREEN)üì¶ Dependencias instaladas:$(NC)"
	@$(NPM) list --depth=0

outdated: ## Verificar dependencias desactualizadas
	@echo "$(YELLOW)üîç Verificando dependencias desactualizadas...$(NC)"
	@$(NPM) outdated

audit: ## Auditor√≠a de seguridad
	@echo "$(GREEN)üîí Ejecutando auditor√≠a de seguridad...$(NC)"
	@$(NPM) audit

audit-fix: ## Corregir vulnerabilidades autom√°ticamente
	@echo "$(GREEN)üîß Corrigiendo vulnerabilidades...$(NC)"
	@$(NPM) audit fix

# ============================================
# üîß UTILIDADES
# ============================================

check-env: ## Verificar variables de entorno
	@echo "$(GREEN)üîç Verificando variables de entorno...$(NC)"
	@if [ -f ".env" ]; then \
		echo "$(GREEN)‚úÖ Archivo .env encontrado$(NC)"; \
		grep -v '^#' .env | grep VITE_ || echo "$(YELLOW)‚ö†Ô∏è No se encontraron variables VITE_*$(NC)"; \
	else \
		echo "$(RED)‚ùå No se encontr√≥ archivo .env$(NC)"; \
	fi

create-env: ## Crear archivo .env de ejemplo
	@echo "$(GREEN)üìù Creando .env de ejemplo...$(NC)"
	@if [ ! -f .env ]; then \
		echo "VITE_API_URL=http://localhost:5000/api" > .env; \
		echo "$(GREEN)‚úÖ Archivo .env creado$(NC)"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è El archivo .env ya existe$(NC)"; \
	fi

open: ## Abrir aplicaci√≥n en el navegador
	@echo "$(BLUE)üåê Abriendo navegador...$(NC)"
	@if command -v xdg-open > /dev/null; then \
		xdg-open http://localhost:$(DEV_PORT); \
	elif command -v open > /dev/null; then \
		open http://localhost:$(DEV_PORT); \
	elif command -v start > /dev/null; then \
		start http://localhost:$(DEV_PORT); \
	else \
		echo "$(YELLOW)‚ö†Ô∏è No se pudo abrir el navegador autom√°ticamente$(NC)"; \
	fi

serve: ## Servir build localmente (usando http-server)
	@echo "$(GREEN)üåê Sirviendo build...$(NC)"
	@if [ ! -d "$(DIST_DIR)" ]; then \
		echo "$(RED)‚ùå No se encontr√≥ $(DIST_DIR). Ejecuta 'make build' primero$(NC)"; \
		exit 1; \
	fi
	npx http-server $(DIST_DIR) -p $(DEV_PORT) -c-1

# ============================================
# üé® ASSETS
# ============================================

optimize-images: ## Optimizar im√°genes
	@echo "$(GREEN)üé® Optimizando im√°genes...$(NC)"
	@npx @squoosh/cli --webp auto public/**/*.{jpg,png} || \
		echo "$(YELLOW)‚ö†Ô∏è Instala @squoosh/cli para optimizar im√°genes$(NC)"

# ============================================
# üéØ ATAJOS
# ============================================

i: install ## Atajo para install
d: dev ## Atajo para dev
b: build ## Atajo para build
p: preview ## Atajo para preview
t: test ## Atajo para test
l: lint ## Atajo para lint
c: clean ## Atajo para clean
